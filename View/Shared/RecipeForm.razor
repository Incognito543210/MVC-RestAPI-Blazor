<div>
    <EditForm Model="@Recipe" OnValidSubmit="@SubmitRecipe">
        <DataAnnotationsValidator />
        <MudStack Row="true">
            <MudTextField @bind-Value="Recipe.Title" Label="Nazwa" For="@(() => Recipe.Title)"></MudTextField>
            <MudNumericField @bind-Value="Recipe.Portions" Label="Liczba porcji" Step="1" Min="1" For="@(() => Recipe.Portions)" />
            <MudTimePicker Label="Czas przygotowania" @bind-Time="Recipe.PrepTimeAsTimeSpan" For="@(() => Recipe.PrepTimeAsTimeSpan)" />
            <MudSelect T="int" Label="Stopień trudności" @bind-Value="Recipe.Difficulty" AnchorOrigin="Origin.BottomCenter" For="@(() => Recipe.Difficulty)">
                <MudSelectItem T="int" Value="1" />
                <MudSelectItem T="int" Value="2" />
                <MudSelectItem T="int" Value="3" />
                <MudSelectItem T="int" Value="4" />
                <MudSelectItem T="int" Value="5" />
            </MudSelect>
        </MudStack>
        <p><MudTextField T="string" @bind-Value="Recipe.Content" Label="Opis przygotowania" Text="@Recipe.Content" Lines="10" For="@(() => Recipe.Content)" /></p>
        <p><MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Style="@($"background:{Colors.Cyan.Default}; color:{Colors.Grey.Lighten5};")" EndIcon="@Icons.Material.Filled.ArrowForward" FullWidth="true">Dodaj przepis</MudButton></p>
    </EditForm>
    <MudStack Row="true">
        <EditForm Model="@ingredient" OnValidSubmit="@AddIngredientToList">
            <DataAnnotationsValidator />
            <MudStack Row="true">
                <MudTextField @bind-Value="ingredient.Name" Label="Składnik" For="@(() => ingredient.Name)"></MudTextField>
                <MudTextField @bind-Value="ingredient.Quantity" Label="Ilość" For="@(() => ingredient.Quantity)"></MudTextField>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Style="@($"background:{Colors.Cyan.Default}; color:{Colors.Grey.Lighten5};")" EndIcon="@Icons.Material.Filled.ArrowForward">Dodaj składnik</MudButton>
            </MudStack>
        </EditForm>
        <EditForm Model="@tag" OnValidSubmit="@AddTagToList">
            <DataAnnotationsValidator />
            <MudStack Row="true">
                <MudSelect T="string" Label="Lista tagów" AnchorOrigin="Origin.BottomCenter" OpenIcon="@Icons.Material.Filled.Bookmarks" @bind-Value="tag.Name">
                    @foreach (var item in Tags)
                    {
                        <MudSelectItem Value="@item.Name">@item.Name</MudSelectItem>
                    }
                </MudSelect>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Style="@($"background:{Colors.Cyan.Default}; color:{Colors.Grey.Lighten5};")" EndIcon="@Icons.Material.Filled.ArrowForward">Dodaj tag</MudButton>
            </MudStack>
        </EditForm><br />
    </MudStack><br />


    @if (Recipe.Ingridients.Count == 0)
    {
        <p>
            Ten przepis nie ma składników
        </p>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Składnik</th>
                    <th>Ilość</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Recipe.Ingridients)
                {
                    <tr>
                        <td>
                            @item.Name
                        </td>
                        <td>
                            @item.Quantity                          
                        </td>
                        <td>
                            <button class="btn btn-primary" @onclick="@(() => UpdateIngredientInList(item))">📝</button>
                            <button class="btn btn-danger" @onclick="@(() => DeleteIngredientFromList(item))">❌</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    }

@if (Recipe.Tags.Count == 0)
    {
        <p>
            Ten przepis nie ma tagów
        </p>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Tag</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Recipe.Tags)
                {
                    <tr>
                        <td>
                            @item.Name
                        </td>
                        <td>
                            <button class="btn btn-danger" @onclick="@(() => DeleteTagFromList(item))">❌</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

    }
</div>


@code {
    [Parameter]
    public EventCallback OnValidSubmit { get; set; }

    [Parameter]
    public RecipeAdapter Recipe { get; set; }

    [Parameter]
    public List<TagDto> Tags { get; set; }


    IngridientDto ingredient = new();
    TagDto tag = new();

    TimeSpan DateTimeToTimeSpan(DateTime? ts)
    {
        if (!ts.HasValue) return TimeSpan.Zero;
        else return new TimeSpan(0, ts.Value.Hour, ts.Value.Minute, ts.Value.Second, ts.Value.Millisecond);
    }

    void AddIngredientToList()
    {
        Recipe.Ingridients.Add(ingredient);
        ingredient = new();
    }

    void AddTagToList()
    {
        bool IsInList = false;
        foreach (var item in Recipe.Tags)
        {
            if (item.Name == tag.Name)
            {
                IsInList = true;
            }
        }
        if(!IsInList)
        {
            Recipe.Tags.Add(tag);
        }
        tag = new();
    }

    void UpdateIngredientInList(IngridientDto ingredient)
    {
        DeleteIngredientFromList(ingredient);
        this.ingredient = ingredient;
    }

    void DeleteIngredientFromList(IngridientDto ingredient)
    {
        Recipe.Ingridients.Remove(ingredient);
    }

    void DeleteTagFromList(TagDto tag)
    {
        Recipe.Tags.Remove(tag);
    }

    async Task SubmitRecipe()
    {
        if (Recipe.Ingridients.Count != 0)
        {      
            await OnValidSubmit.InvokeAsync();
        }
    }
   
}
